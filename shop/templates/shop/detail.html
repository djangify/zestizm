{% extends "base.html" %}
{% load static %}

{% block open_graph_tags %}
  <meta property="og:title" content="{{ product.meta_title|default:product.title }}" />
  {% if product.meta_description %}
    <meta property="og:description" content="{{ product.meta_description|truncatewords:25 }}" />
  {% else %}
    <meta property="og:description" content="{{ product.description|truncatewords:25 }}" />
  {% endif %}
  <meta property="og:image" content="{{ product.get_image_url|default:'/static/images/placeholder.webp' }}" />
  <meta property="og:url" content="{{ request.build_absolute_uri }}" />
  <meta property="og:type" content="product" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ product.meta_title|default:product.title }}" />
  {% if product.meta_description %}
    <meta name="twitter:description" content="{{ product.meta_description|truncatewords:25 }}" />
  {% else %}
    <meta name="twitter:description" content="{{ product.description|truncatewords:25 }}" />
  {% endif %}
  <meta name="twitter:image" content="{{ product.get_image_url|default:'/static/images/djangify-logo.png' }}" />
{% endblock %}

{% block content %}
<div class="min-h-screen mt-4 bg-[color:var(--color-brand-light)]/10">
  <div class="container mx-auto px-4 py-12">
   

    <div class="max-w-7xl mx-auto lg:grid lg:grid-cols-3 gap-12 space-y-8 lg:space-y-0">
      <!-- LEFT COLUMN -->
      <div class="lg:col-span-1 space-y-6">

        <!-- Main Product Image -->
        <div class="relative bg-[color:var(--color-brand-light)] overflow-hidden rounded-lg border border-[color:var(--color-brand-accent)]">
          <img
            id="main-product-image"
            src="{{ product.get_image_url|default:'/static/images/placeholder.webp' }}"
            alt="Cover design of {{ product.title }}"
            class="block h-auto w-full object-contain transition duration-300"
          />

          {% if product.is_on_sale %}
          <div class="absolute top-4 right-4">
            <span class="px-3 py-1 text-sm font-bold bg-[color:var(--color-brand-accent)] text-[color:var(--color-brand-light)] rounded-full">SALE</span>
          </div>
          {% endif %}
        </div>

        <!-- Thumbnails -->
        <div class="flex mt-4 gap-4 justify-center">
          <img
            src="{{ product.get_image_url|default:'/static/images/placeholder.webp' }}"
            data-src="{{ product.get_image_url|default:'/static/images/placeholder.webp' }}"
            alt="Thumbnail preview of {{ product.title }}"
            class="w-20 h-20 object-cover border-2 border-[color:var(--color-brand-primary)] rounded hover:shadow-md cursor-pointer product-thumbnail active-thumbnail"
          />
          {% for img in product.images.all %}
          <img
            src="{{ img.image.url }}"
            data-src="{{ img.image.url }}"
            alt="{{ img.alt_text|default:'Additional product image' }}"
            class="w-20 h-20 object-cover border border-[color:var(--color-brand-accent)] rounded hover:shadow-md cursor-pointer product-thumbnail"
          />
          {% endfor %}
        </div>

        <!-- Quantity + Add to Cart -->
        <div class="pt-6 space-y-6">
          {% if product.status == "publish" %}
          <form method="post" action="{% url 'shop:cart_add' product.id %}" class="space-y-4">
            {% csrf_token %}
            <div class="flex items-center justify-between gap-4">
              <label class="text-sm font-medium text-[color:var(--color-font-main)]">Quantity:</label>
              <input type="number" name="quantity" value="1" min="1" max="10"
                class="w-16 px-3 py-2 border border-[color:var(--color-brand-accent)] rounded text-center">
              <button type="submit"
                class="flex-1 bg-[color:var(--color-brand-primary)] hover:bg-[color:var(--color-brand-secondary)] text-[color:var(--color-brand-light)] font-bold py-3 px-6 rounded-xl transition duration-300 hover:scale-105 shadow-md">
                Add to Cart
              </button>
            </div>
          </form>
          {% else %}
          <div class="text-[color:var(--color-brand-dark)] bg-[color:var(--color-brand-light)] border border-[color:var(--color-brand-accent)] p-4 rounded">
            This product is <strong>{{ product.get_status_display }}</strong>.
          </div>
          {% endif %}

          <!-- Wishlist -->
          <button
            class="favourite-btn bg-[color:var(--color-brand-secondary)] w-full py-3 rounded-xl shadow-md font-semibold hover:bg-[color:var(--color-brand-primary)] transition"
            data-product-slug="{{ product.slug }}"
            data-action-url="{% url 'accounts:add_to_wishlist' product.slug %}"
            data-csrf="{{ csrf_token }}">
            {% if product in user.profile.favourite_products.all %}
              ‚ù§Ô∏è Remove from Wish List
            {% else %}
              ü§ç Add To Wish List
            {% endif %}
          </button>

          <!-- Purchased Info -->
          {% if has_purchased and order_item %}
          <div class="bg-[color:var(--color-brand-light)] border border-[color:var(--color-brand-primary)] text-[color:var(--color-brand-dark)] font-semibold p-4 rounded mb-4">
            ‚úÖ You purchased this product on {{ order_item.order.created|date:"j M Y" }} (Order ID: {{ order_item.order.order_id }})
          </div>
          {% endif %}

          <!-- Secure Purchase Info -->
<div class="mt-6 border-t border-[color:var(--color-brand-accent)] pt-5">
  <div class="flex flex-wrap justify-evenly items-center text-sm text-[color:var(--color-font-main)] gap-y-3 text-center sm:text-left">
    
    <!-- Secure Payment -->
    <div class="flex items-center gap-1 whitespace-nowrap">
      <span class="text-[color:var(--color-brand-secondary)]">‚úî</span>
      <span>Secure Payment</span>
    </div>

    <!-- Easy Downloads + Account -->
    <div class="flex items-center gap-1 whitespace-nowrap">
      <span class="text-[color:var(--color-brand-secondary)]">‚úî</span>
      <span>
        Download product in your 
        <a href="{% url 'accounts:register' %}" 
           class="underline hover:text-[color:var(--color-brand-secondary)] font-medium">
          account
        </a>
      </span>
    </div>
  </div>
</div>


          <!-- Download Preview -->
          {% if product.get_preview_url %}
          <div class="mt-10 p-6 rounded-lg border border-[color:var(--color-brand-primary)]">
            <h3 class="text-lg font-semibold mb-3 flex items-center text-[color:var(--color-font-main)]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-[color:var(--color-brand-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Download Preview Of {{ product.title }}
            </h3>
            <a href="{{ product.get_preview_url }}" download
               class="inline-flex items-center justify-center gap-2 px-5 py-3 w-full border border-[color:var(--color-brand-primary)] rounded-md text-[color:var(--color-font-main)] hover:bg-[color:var(--color-brand-light)] transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--color-brand-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              Download Product Preview
            </a>
          </div>
          {% endif %}

          <!-- Disclaimer -->
          <p class="mt-6 pt-4 border-t text-[color:var(--color-font-main)] text-xs leading-relaxed">
            <strong>DISCLAIMER:</strong> Every digital file includes a small invisible watermark linked to your order. 
            This helps protect our work from being shared online. Thank you for supporting independent creators.
          </p>

          <!-- Video -->
          {% include 'components/videos.html' %}
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="lg:col-span-2 space-y-6">
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold text-[color:var(--color-brand-dark)] mb-4">
            {{ product.title }}
          </h1>
        </div>

        <div class="flex items-center space-x-4">
          <span class="text-4xl font-bold text-[color:var(--color-brand-primary)]">${{ product.current_price }}</span>
          {% if product.is_on_sale %}
          <span class="text-2xl text-[color:var(--color-brand-accent)] line-through ml-3">${{ product.price }}</span>
          {% endif %}
        </div>

        <div class="flex items-center gap-1 mt-1">
          <div class="flex">
            {% for i in "12345"|make_list %}
              {% if forloop.counter <= product.average_rating %}
                <svg class="w-5 h-5 text-[color:var(--color-brand-secondary)] fill-[color:var(--color-brand-secondary)]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.782L19.868 24 12 19.896 4.132 24l2.934-9.008L1.132 9.21l8.2-1.192z"/></svg>
              {% else %}
                <svg class="w-5 h-5 text-[color:var(--color-brand-accent)]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.782L19.868 24 12 19.896 4.132 24l2.934-9.008L1.132 9.21l8.2-1.192z"/></svg>
              {% endif %}
            {% endfor %}
          </div>
          <span class="ml-2 text-sm text-[color:var(--color-font-main)]">
            ({{ product.total_reviews }} review{{ product.total_reviews|pluralize }})
          </span>
        </div>

        <div class="prose text-[color:var(--color-font-main)]">
          {{ product.description|safe }}
        </div>

        <!-- Accordion -->
        <div class="mt-6 border-t border-[color:var(--color-brand-accent)] pt-6">
          <div class="accordion-header flex items-center justify-between cursor-pointer" data-target="product-long-description">
            <h3 class="text-lg font-semibold text-[color:var(--color-brand-primary)]">More Product Info Here</h3>
            <svg class="w-5 h-5 transition-transform accordion-icon text-[color:var(--color-brand-accent)]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
          </div>
          <div id="product-long-description" class="prose hidden text-[color:var(--color-font-main)]">
            {{ product.long_description|safe }}

            {% if product.status == "publish" %}
            <form method="post" action="{% url 'shop:cart_add' product.id %}" class="flex items-center justify-start gap-4 mt-6">
              {% csrf_token %}
              <label class="text-sm font-medium text-[color:var(--color-font-main)]">Qty:</label>
              <input type="number" name="quantity" value="1" min="1" max="10"
                     class="w-16 px-3 py-2 border border-[color:var(--color-brand-accent)] rounded text-center">
              <button type="submit"
                      class="bg-[color:var(--color-brand-primary)] hover:bg-[color:var(--color-brand-secondary)] text-[color:var(--color-brand-light)] font-bold py-3 px-6 rounded-xl transition duration-300 hover:scale-105 shadow-md">
                Buy Now
              </button>
            </form>
            {% endif %}
          </div>
        </div>

        <!-- Reviews -->
        {% include 'components/reviews.html' %}

        <!-- Related Products -->
        {% if related_products %}
        <section class="mt-20">
          <h2 class="text-2xl font-bold text-[color:var(--color-brand-dark)] mb-8">Related Products</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for item in related_products %}
            <a href="{{ item.get_absolute_url }}" class="group block">
              <div class="bg-[color:var(--color-brand-light)] rounded-lg shadow-sm hover:shadow-md transition-shadow overflow-hidden">
                <div class="relative aspect-square overflow-hidden">
                  <img src="{{ item.get_image_url|default:'/static/images/placeholder.webp' }}"
                       class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                  {% if item.is_on_sale %}
                  <span class="absolute top-2 right-2 bg-[color:var(--color-brand-accent)] text-[color:var(--color-brand-light)] text-xs font-bold px-2 py-1 rounded">SALE</span>
                  {% endif %}
                </div>
                <div class="p-4">
                  <h3 class="font-semibold text-[color:var(--color-brand-dark)] mb-2 group-hover:text-[color:var(--color-brand-primary)] transition-colors">
                    {{ item.title }}
                  </h3>
                  <div class="flex items-center space-x-2">
                    <span class="text-lg font-bold text-[color:var(--color-font-main)]">${{ item.current_price }}</span>
                    {% if item.is_on_sale %}
                    <span class="text-sm text-[color:var(--color-brand-accent)] line-through">${{ item.price }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
        </section>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Thumbnail Switch Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const mainImage = document.getElementById("main-product-image");
  const thumbnails = document.querySelectorAll(".product-thumbnail");
  thumbnails.forEach((thumb) => {
    thumb.addEventListener("click", function () {
      thumbnails.forEach(t => t.classList.remove("active-thumbnail", "border-2", "border-[color:var(--color-brand-primary)]"));
      this.classList.add("active-thumbnail", "border-2", "border-[color:var(--color-brand-primary)]");
      const newSrc = this.getAttribute("data-src");
      if (newSrc) mainImage.setAttribute("src", newSrc);
    });
  });
});
</script>

<!-- Accordion Script -->
<script>
document.querySelectorAll(".accordion-header").forEach(header => {
  header.addEventListener("click", () => {
    const target = document.getElementById(header.dataset.target);
    const icon = header.querySelector(".accordion-icon");
    target.classList.toggle("hidden");
    icon.classList.toggle("rotate-180");
  });
});
</script>

<script src="{% static 'js/favourite-products.js' %}"></script>
{% endblock %}
